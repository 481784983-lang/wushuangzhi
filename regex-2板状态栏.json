{
    "id": "f28a1425-6ac8-4deb-be4b-5009eb4ee3c9",
    "scriptName": "2板状态栏",
    "findRegex": "<StatusPlaceHolderImpl/>",
    "replaceString": "```html\n<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\" />\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" />\n    <title>天下为棋-无双志 v21（多气泡分离模式）</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css\">\n    <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n    <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n    <link href=\"https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,400;1,400&family=Noto+Sans+SC:wght@400;500;700&family=Almendra+SC&family=Cinzel+Decorative:wght@700&family=EB+Garamond&family=Josefin+Sans&family=Playfair+Display&family=Roboto+Slab&family=Spectral&display=swap\" rel=\"stylesheet\">\n<style>\n    /* --- [ 0. 基础 ] --- */\n    :root { --ease-snap: cubic-bezier(.12,.72,.24,1); }\n\n    body { font-family: 'Noto Sans SC', 'Merriweather', serif; background-color: #1a1c23; color: #e0e0e0; margin: 0; padding: 15px; }\n    .hidden { display: none !important; }\n    .value-main { font-weight: 500; color: #ffffff; }\n    .property-name { font-weight: bold; color: #a0a0a0; }\n    .empty-state-text { color: #a0a0a0; font-style: italic; text-align: center; padding: 10px; opacity: 0.7; }\n\n    .status-container { max-width: 900px; margin: auto; transition: all 0.8s ease; border-radius: 12px; color: #e0e0e0; }\n    .status-container > div { position: relative; z-index: 1; }\n    .status-container div, .status-container p, .status-container span, \n    .status-container summary, .status-container details { font-family: inherit; color: #e0e0e0; }\n\n    .master-ui-title { text-align: center; padding: 10px 0 5px 0; }\n    .master-ui-title h1 {\n        font-family: var(--theme-font-title, 'Cinzel Decorative', serif); \n        font-size: 3.0em; font-weight: 700; margin: 0; color: #e0e0e0;\n        text-shadow: 0 0 8px rgba(255,255,255,0.7), 0 0 15px var(--theme-accent-glow, #a8904a), 2px 2px 5px rgba(0,0,0,0.7);\n    }\n    .yongtan-footer { text-align: center; padding-top: 15px; margin-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1); }\n\n    /* --- [ 1. 主题定义 ] --- */\n    #chessboard-container-wrapper.theme-imperial { \n        --theme-accent-glow: #a8904a; \n        --theme-font-title: 'Cinzel Decorative', serif;\n        --theme-font-header: 'Playfair Display', serif;\n        font-family: 'Playfair Display', serif; \n        background-color: #1e222a; border: 2px solid #a8904a; \n        padding: 20px; animation: regal-pulse-imperial 8s infinite ease-in-out;\n    }\n    #chessboard-container-wrapper.theme-elven { \n        --theme-accent-glow: #00ff7f; \n        --theme-font-title: 'Josefin Sans', sans-serif;\n        --theme-font-header: 'EB Garamond', serif;\n        font-family: 'EB Garamond', serif; \n        background: #1a232a url('https://www.transparenttextures.com/patterns/stardust.png'); \n        border: 1px solid rgba(0, 255, 127, 0.5); \n        padding: 20px; animation: shimmer-glow-elven 6s infinite ease-in-out; \n    }\n    #chessboard-container-wrapper.theme-draconic { \n        --theme-accent-glow: #D4AF37; \n        --theme-font-title: 'Almendra SC', serif;\n        --theme-font-header: 'Cinzel', serif;\n        font-family: 'Cinzel Decorative', cursive; \n        background-color: #100808; border: 2px solid #8b0000; \n        padding: 20px; animation: pulse-glow-draconic 4s infinite ease-in-out;\n    }\n    #chessboard-container-wrapper.theme-draconic details.sub-section > summary { background-color: #3a0000; }\n    #chessboard-container-wrapper.theme-draconic .master-ui-title h1 { color: var(--theme-accent-glow); }\n\n    #chessboard-container-wrapper.theme-abyss { \n        --theme-accent-glow: #8a2be2;\n        --theme-font-title: 'Cinzel Decorative', serif;\n        --theme-font-header: 'Spectral', serif;\n        font-family: 'Almendra SC', serif; \n        background: #0d0a1a url('https://www.transparenttextures.com/patterns/dark-matter.png'); \n        border: 2px solid #4b0082; padding: 20px; \n        animation: pulse-glow-abyss 4s infinite ease-in-out; \n        position: relative;\n        overflow: visible; \n        isolation: isolate; \n    }\n    #chessboard-container-wrapper.theme-abyss::before {\n        content: ''; position: absolute; inset: 0; \n        background: linear-gradient(45deg, rgba(75,0,130,0.3) 0%, rgba(138,43,226,0.1) 50%, rgba(75,0,130,0.3) 100%);\n        animation: abyss-flow 10s infinite linear; z-index: 0; pointer-events: none;\n    }\n\n    /* 光效动画 */\n    @keyframes regal-pulse-imperial {\n        0%, 100% { box-shadow: 0 10px 40px rgba(0,0,0,0.7), inset 0 0 20px rgba(0,0,0,0.6), 0 0 20px #a8904a; }\n        50% { box-shadow: 0 10px 40px rgba(0,0,0,0.7), inset 0 0 20px rgba(0,0,0,0.6), 0 0 35px #a8904a; }\n    }\n    @keyframes shimmer-glow-elven {\n        0%, 100% { box-shadow: 0 0 25px rgba(0, 255, 127, 0.4), 0 0 45px rgba(0, 255, 127, 0.2) inset; }\n        50% { box-shadow: 0 0 35px rgba(0, 255, 127, 0.6), 0 0 45px rgba(175, 238, 238, 0.3) inset; }\n    }\n    @keyframes pulse-glow-draconic {\n        0%, 100% { box-shadow: 0 0 20px #8b0000, 0 0 30px #6a0000, inset 0 0 20px #100808; border-color: #8b0000; }\n        50% { box-shadow: 0 0 35px #c0392b, 0 0 45px #8b0000, inset 0 0 20px #100808; border-color: #c0392b; }\n    }\n    @keyframes pulse-glow-abyss { \n        0%, 100% { box-shadow: 0 0 25px #8a2be2, 0 0 35px #4b0082; } \n        50% { box-shadow: 0 0 40px #9400d3, 0 0 55px #4b0082; } \n    }\n    @keyframes abyss-flow {\n        0% { transform: rotate(0deg) translateX(0); }\n        50% { transform: rotate(10deg) translateX(-10%); }\n        100% { transform: rotate(0deg) translateX(0); }\n    }\n\n    /* --- [ 2. 日常 UI 结构样式（*修改*） ] --- */\n    .world-info-box { background-color: rgba(0,0,0,0.2); padding: 12px 18px; border-radius: 6px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; align-items: center; }\n    .world-info-box p { margin: 5px 0; font-family: 'Noto Sans SC', sans-serif; } \n\n    /* *修改*：移除了 .section，只保留 .sub-section */\n    details.sub-section { margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; background: rgba(10,10,15,0.2); }\n    /* *修改*：限定为 .sub-section 的 summary */\n    details.sub-section > summary { display: flex; justify-content: space-between; align-items: center; list-style: none; padding: 12px 15px; cursor: pointer; font-weight: 700; font-family: var(--theme-font-header, 'Cinzel', serif); transition: all 0.2s ease; }\n    details.sub-section > summary:hover { background: rgba(255, 255, 255, 0.05); }\n    details.sub-section > summary::-webkit-details-marker { display: none; }\n    /* *修改*：限定为 .sub-section 的 summary 内部的 icon */\n    details.sub-section > summary .summary-icon { margin-right: 10px; color: #a0a0a0; opacity: 0.8; }\n    \n    .arrow-toggle { transition: transform 0.3s ease; margin-left: auto;}\n    /* *修改*：限定为 .sub-section */\n    details.sub-section[open] > summary .arrow-toggle { transform: rotate(90deg); }\n    \n    /* .section-content 依然由 JS 生成，保持原样 */\n    .section-content, .sub-section-content { padding: 15px; background-color: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); }\n    /* *修改*：.section-content 不再是 details 的直接子元素，移除边框 */\n    .section-content { border-top: none; }\n    /* *修改*：为 .sub-section-content 添加边框（它现在是 .section-content 里的 details 的子元素） */\n    .sub-section-content { border-top: 1px solid rgba(255, 255, 255, 0.08); }\n    \n    hr { border: 0; height: 1px; background-image: linear-gradient(to right, transparent, rgba(255,255,255,0.2), transparent); margin: 15px 0; }\n    .char-property-grid, .item-row, .char-favor-bar-container, .news-content, .poem-grid { font-family: 'Noto Sans SC', sans-serif !important; }\n    .char-property-grid { display: grid; grid-template-columns: 22px auto 1fr; gap: 9px 8px; align-items: start; }\n    .char-property-grid .char-icon { font-size: 1.1em; text-align: center; opacity: 0.8; margin-top: 1px; color: #a0a0a0; }\n    .char-property-grid .char-prop-name { font-weight: bold; color: #a0a0a0; white-space: nowrap; }\n    .char-property-grid .char-prop-value { color: #e0e0e0; text-align: right; word-break: break-word; line-height: 1.4; }\n    .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }\n    .item-row:last-child { border-bottom: none; }\n    .char-favor-bar-container { background-color: rgba(0,0,0,0.4); border-radius: 5px; height: 10px; overflow:hidden; border: 1px solid #202020; padding: 1px; }\n    .char-favor-bar { background: #e64b6e; height: 100%; border-radius: 5px; transition: width 0.5s ease; }\n    .news-content { font-size: 0.9em; line-height: 1.7; color: #e0e0e0; white-space: pre-line; padding: 5px; }\n    .poem-grid { display: grid; grid-template-columns: 1fr; gap: 5px 20px; padding: 10px 0; font-family: var(--theme-font-header, 'Cinzel', serif); font-size: 1.2em; line-height: 1.6; color: #a0a0a0; text-align: center; }\n    .poem-grid p { margin: 0; }\n\n    /* --- [ 3. 大气泡样式（保持不变） ] --- */\n    .bubble-shell { margin-top: 10px; position: relative; z-index: 1; }\n    .bubble-toggle {\n        display: inline-flex; align-items: center; gap: 10px; padding: 10px 16px; border-radius: 999px; cursor: pointer; user-select: none;\n        background: radial-gradient(120% 200% at 0 0, rgba(255,255,255,.12), transparent 45%), linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));\n        border: 1px solid rgba(255,255,255,.18); \n        box-shadow: 0 2px 10px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.06);\n        transition: transform .25s ease, box-shadow .35s ease, filter .35s ease;\n        font-family: var(--theme-font-header, 'Playfair Display', serif); font-weight: 700;\n        color: #e0e0e0; /* *新增*：确保文字颜色 */\n    }\n    .bubble-toggle:hover { transform: translateY(-1px) scale(1.02); box-shadow: 0 8px 22px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.08); }\n    .bubble-toggle .pulse-dot { width: 10px; height: 10px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #fff, var(--theme-accent-glow)); box-shadow: 0 0 10px var(--theme-accent-glow), 0 0 20px var(--theme-accent-glow); animation: dot 1.8s infinite ease-in-out; }\n    @keyframes dot { 0%,100%{transform:scale(1);opacity:.9} 50%{transform:scale(1.3);opacity:1} }\n    \n    /* *新增*：气泡按钮内的图标样式 */\n    .bubble-toggle .summary-icon {\n        margin-right: 8px;\n        color: #e0e0e0;\n        opacity: 0.9;\n        font-size: 1.1em;\n    }\n\n    .big-bubble {\n        position: relative; margin-top: 12px; border-radius: 20px;\n        background: radial-gradient(1200px 500px at 10% -10%, rgba(255,255,255,.06), transparent 60%),\n                    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),\n                    rgba(16,16,22,.45);\n        border: 1px solid rgba(255,255,255,.18);\n        box-shadow: inset 0 0 0 1px rgba(255,255,255,.05), 0 10px 30px rgba(0,0,0,.45), 0 0 28px rgba(138,43,226,.35);\n        backdrop-filter: blur(8px) saturate(110%);\n        max-height: 0; overflow: hidden; opacity: 0; transform: scale(.985);\n        transform-origin: var(--origin-x, 50%) var(--origin-y, 16px);\n        transition: max-height .6s var(--ease-snap), opacity .25s ease-out, transform .42s var(--ease-snap), box-shadow .35s ease-out;\n    }\n    .bubble-shell.open .big-bubble { opacity: 1; transform: scale(1); }\n    .big-bubble::after { content:''; position:absolute; inset:-40% -20%; \n        background: conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,.06), transparent 20%, transparent 60%, rgba(255,255,255,.06) 80%, transparent);\n        mix-blend-mode: screen; opacity:.4; pointer-events:none; animation: sweep 8s linear infinite;\n    }\n    @keyframes sweep { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }\n    .bubble-inner { padding: 16px; position: relative; z-index: 1; }\n\n    /* --- [ 4. 战斗 UI v2.0 (保持你原样式) ] --- */\n    /* ... (战斗 UI 的 CSS 保持不变，此处省略以节约篇幅) ... */\n    :root { \n        --battle-border-color: #4a4a4a;\n        --battle-font-primary: 'Noto Sans SC', sans-serif;\n        --battle-font-secondary: 'Cinzel', 'EB Garamond', 'Noto Serif SC', serif; \n        --blood-red-dark: #6a0000;\n        --blood-red: #8B0000;\n        --blood-red-light: #c0392b;\n        --accent-gold-battle: #D4AF37; \n        --text-light: #f0f0f0;\n        --text-dark: #1a1a1a;\n        --text-secondary-battle: #999; \n        --hp-color: #c0392b;\n        --hp-color-light: #e74c3c;\n        --mp-color: #2980b9;\n        --mp-color-light: #3498db;\n        --bar-bg: #333;\n        --overlay-bg: rgba(0, 0, 0, 0.85);\n        --parchment-bg-dark: #2a2a2a; \n    }\n    @keyframes pulse-glow-battle {\n        0%, 100% { box-shadow: 0 0 25px rgba(139, 0, 0, 0.6), inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 0, 0, 0.5); }\n        50% { box-shadow: 0 0 35px rgba(255, 0, 0, 0.8), inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 25px rgba(255, 0, 0, 0.7); }\n    }\n    @keyframes bar-flow {\n        0% { transform: translateX(-100%); }\n        100% { transform: translateX(200%); }\n    }\n    #battle-ui-wrapper {\n        max-width: 900px; margin: 10px auto; padding: 12px;\n        background-color: #1a1a1a;\n        background-image: linear-gradient(135deg, rgba(139, 0, 0, 0.3) 0%, rgba(0,0,0,0) 60%),\n                            radial-gradient(ellipse at bottom, rgba(100, 0, 0, 0.4) 0%, rgba(0,0,0,0) 70%),\n                            linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),\n                            url('https://www.transparenttextures.com/patterns/rocky-wall.png');\n        border: 2px solid var(--blood-red); border-radius: 8px;\n        font-family: var(--battle-font-primary); color: var(--text-light);\n        font-size: 14px; line-height: 1.6; display: flex; flex-direction: column;\n        gap: 12px; animation: pulse-glow-battle 5s infinite ease-in-out;\n    }\n    #battle-ui-wrapper .combatant-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }\n    #battle-ui-wrapper .team {\n        display: flex; flex-direction: column; gap: 8px; padding: 10px;\n        background: rgba(10,10,15,0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px;\n    }\n    #battle-ui-wrapper .team-title {\n        font-family: var(--battle-font-secondary);\n        font-weight: 700; font-size: 1.4em; color: var(--accent-gold-battle);\n        text-align: center; border-bottom: 1px solid var(--blood-red);\n        padding-bottom: 5px; margin-bottom: 5px; text-shadow: 0 0 5px var(--accent-gold-battle);\n    }\n    #battle-ui-wrapper .combatant-bar {\n        padding: 8px 12px; background: #2b2b2b;\n        border: 1px solid var(--battle-border-color);\n        border-radius: 4px; cursor: pointer;\n        transition: all 0.3s ease;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n    }\n    #battle-ui-wrapper .combatant-bar:hover { background: #3a3a3a; border-color: var(--accent-gold-battle); }\n    #battle-ui-wrapper .combatant-bar.selected { animation: target-lock-pulse 2s infinite ease-in-out; }\n    @keyframes target-lock-pulse {\n        0%, 100% { background: var(--blood-red-dark); border-color: var(--accent-gold-battle); box-shadow: 0 0 10px var(--accent-gold-battle); }\n        50% { background: #8f0000; border-color: #fff; box-shadow: 0 0 20px #fff, 0 0 10px var(--accent-gold-battle); }\n    }\n    #battle-ui-wrapper .combatant-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1em; margin-bottom: 6px; }\n    #battle-ui-wrapper .combatant-name { font-family: var(--battle-font-secondary); color: var(--text-light); text-shadow: 1px 1px 2px #000; }\n    #battle-ui-wrapper .combatant-type { font-size: 0.8em; color: var(--text-secondary-battle); }\n    #battle-ui-wrapper .stat-bars { display: flex; flex-direction: column; gap: 4px; }\n    #battle-ui-wrapper .stat-bar { width: 100%; height: 16px; background-color: var(--bar-bg); border: 1px solid #111; border-radius: 3px; position: relative; overflow: hidden; }\n    #battle-ui-wrapper .stat-bar-value::before {\n        content: ''; position: absolute; top: 0; left: 0; width: 50%; height: 100%;\n        background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);\n        animation: bar-flow 3s infinite linear;\n    }\n    #battle-ui-wrapper .stat-bar-value { height: 100%; transition: width 0.5s ease; position: absolute; top: 0; left: 0; }\n    #battle-ui-wrapper .stat-bar-value.hp { background: linear-gradient(90deg, var(--hp-color) 0%, var(--hp-color-light) 100%); }\n    #battle-ui-wrapper .stat-bar-value.mp { background: linear-gradient(90deg, var(--mp-color) 0%, var(--mp-color-light) 100%); }\n    #battle-ui-wrapper .stat-bar-text { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: 700; color: white; text-shadow: 1px 1px 2px #000, 0 0 3px #000; line-height: 14px; }\n    #battle-ui-wrapper .stat-bar-text .label { font-weight: 500; }\n    #battle-ui-wrapper .action-panel { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; min-height: 200px; }\n    #battle-ui-wrapper .tab-panel { display: flex; flex-direction: column; background: rgba(10,10,15,0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; overflow: hidden; }\n    #battle-ui-wrapper .tabs { display: flex; background: #2b2b2b; }\n    #battle-ui-wrapper .tab-button {\n        flex: 1; padding: 10px; background: transparent; border: none; border-bottom: 3px solid transparent;\n        color: var(--text-secondary-battle); font-family: var(--battle-font-secondary);\n        font-size: 1.2em; font-weight: 700; cursor: pointer; transition: all 0.3s ease;\n        text-shadow: 1px 1px 2px #000; \n    }\n    #battle-ui-wrapper .tab-button:hover { color: var(--text-light); background: #3a3a3a; }\n    #battle-ui-wrapper .tab-button.active-tab { color: var(--accent-gold-battle); border-bottom-color: var(--blood-red); background: rgba(0,0,0,0.2); }\n    #battle-ui-wrapper #tab-content-area { padding: 10px; height: 160px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }\n    #battle-ui-wrapper .action-item-button {\n        display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 8px 12px;\n        background: #333; border: 1px solid var(--battle-border-color); border-radius: 4px;\n        color: var(--text-light); cursor: pointer; transition: all 0.3s ease; text-align: left;\n    }\n    #battle-ui-wrapper .action-item-button:hover { background: var(--blood-red-dark); border-color: var(--blood-red-light); }\n    #battle-ui-wrapper .action-item-name { font-weight: 700; font-size: 1.05em; }\n    #battle-ui-wrapper .action-item-cost { font-size: 0.9em; color: var(--mp-color-light); font-weight: 500; }\n    #battle-ui-wrapper .action-item-count { font-size: 0.9em; color: var(--text-secondary-battle); font-weight: 500; }\n    #battle-ui-wrapper .action-item-desc { font-size: 0.85em; color: var(--text-secondary-battle); width: 100%; margin-top: 4px; }\n    #battle-ui-wrapper .core-actions { display: flex; flex-direction: column; gap: 8px; }\n    #battle-ui-wrapper .core-action-button {\n        width: 100%; height: 100%; padding: 15px;\n        font-family: var(--battle-font-secondary); font-size: 1.4em; font-weight: 700;\n        background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), linear-gradient(180deg, var(--blood-red-dark) 0%, #4a0000 100%);\n        background-color: var(--blood-red-dark); color: var(--text-light);\n        border: 1px solid var(--blood-red); border-radius: 6px; cursor: pointer; transition: all 0.3s ease;\n        box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255, 100, 100, 0.2);\n        text-shadow: 0 0 5px #000, 1px 1px 2px #000; \n    }\n    #battle-ui-wrapper .core-action-button:hover {\n        background-color: var(--blood-red-light); color: white;\n        box-shadow: 0 0 10px var(--blood-red-light), 0 0 15px var(--blood-red), inset 0 1px 1px rgba(255, 100, 100, 0.4);\n    }\n    #battle-ui-wrapper .pre-input-area { display: flex; flex-direction: column; gap: 8px; }\n    #battle-ui-wrapper #pre-input-bar { width: 100%; min-height: 60px; background: var(--parchment-bg-dark); border: 1px solid var(--battle-border-color); border-radius: 4px; color: var(--text-light); font-family: var(--battle-font-primary); font-size: 1em; padding: 8px; resize: vertical; }\n    #battle-ui-wrapper #start-turn-button {\n        width: 100%; padding: 12px; font-family: var(--battle-font-secondary);\n        font-size: 1.5em; font-weight: 700; background: var(--accent-gold-battle); color: var(--text-dark);\n        border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;\n        box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);\n    }\n    #battle-ui-wrapper #start-turn-button:hover { background: #fff; color: #000; box-shadow: 0 0 25px #fff; }\n    #battle-ui-wrapper .battle-log-area { height: 150px; background: var(--parchment-bg-dark); border: 1px solid var(--battle-border-color); border-radius: 6px; padding: 12px; overflow-y: auto; white-space: pre-line; font-size: 0.9em; color: var(--text-light); }\n    #battle-ui-wrapper #end-battle-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay-bg); display: flex; justify-content: center; align-items: center; z-index: 100; }\n    #battle-ui-wrapper #end-battle-button {\n        padding: 20px 40px; font-family: var(--battle-font-secondary);\n        font-size: 2em; font-weight: 700; background: var(--accent-gold-battle); color: var(--text-dark);\n        border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;\n        box-shadow: 0 0 20px var(--accent-gold-battle);\n    }\n    #battle-ui-wrapper #end-battle-button:hover { background: #fff; color: #000; transform: scale(1.05); }\n</style>\n</head>\n<body>\n    <div id=\"chessboard-container-wrapper\">\n        <p style=\"color: #a0a0a0; font-style: italic; text-align: center; padding: 20px;\">\n            正在加载“无双志”...\n        </p>\n    </div>\n\n    <div id=\"battle-ui-wrapper\" class=\"hidden\">\n        <div class=\"combatant-area\">\n            <div class=\"team\" id=\"player-combatants-area\">\n                <div class=\"team-title\">我方阵营</div>\n                <p id=\"player-combatants-placeholder\" class=\"empty-state-text\">(等待我方单位...)</p>\n            </div>\n            <div class=\"team\" id=\"enemy-combatants-area\">\n                <div class=\"team-title\">敌方阵营</div>\n                <p id=\"enemy-combatants-placeholder\" class=\"empty-state-text\">(等待敌方单位...)</p>\n            </div>\n        </div>\n        <div class=\"action-panel\">\n            <div class=\"tab-panel\">\n                <div class=\"tabs\">\n                    <button id=\"tab-btn-skills\" class=\"tab-button\" onclick=\"window.battle_ui_events.selectTab('skills')\">\n                        <i class=\"fa-solid fa-magic-wand-sparkles\"></i> 技\n                    </button>\n                    <button id=\"tab-btn-bags\" class=\"tab-button\" onclick=\"window.battle_ui_events.selectTab('bags')\">\n                        <i class=\"fa-solid fa-sack\"></i> 行囊\n                    </button>\n                </div>\n                <div id=\"tab-content-area\">\n                    <p class=\"empty-state-text\">(请选择一个单位)</p>\n                </div>\n            </div>\n            <div class=\"core-actions\">\n                <button class=\"core-action-button\" onclick=\"window.battle_ui_events.coreAction('攻击')\">\n                    <i class=\"fa-solid fa-khanda\"></i> 攻击\n                </button>\n                <button class=\"core-action-button\" onclick=\"window.battle_ui_events.coreAction('防御')\">\n                    <i class=\"fa-solid fa-shield-halved\"></i> 防御\n                </button>\n                <button class=\"core-action-button\" onclick=\"window.battle_ui_events.coreAction('逃跑')\">\n                    <i class=\"fa-solid fa-person-running\"></i> 逃跑\n                </button>\n            </div>\n        </div>\n        <div class=\"pre-input-area\">\n            <textarea id=\"pre-input-bar\" placeholder=\"此处显示您选择的行动...\"></textarea>\n            <button id=\"start-turn-button\" onclick=\"window.battle_ui_events.startTurn()\">\n                <i class=\"fa-solid fa-play\"></i> 开 始\n            </button>\n        </div>\n        <div class=\"battle-log-area\" id=\"battle-log-content\">\n            (战斗日志将显示于此...)\n        </div>\n        <div id=\"end-battle-overlay\" class=\"hidden\">\n            <button id=\"end-battle-button\" onclick=\"window.battle_ui_events.endBattle()\">\n                <i class=\"fa-solid fa-flag-checkered\"></i> 战斗结束\n            </button>\n        </div>\n    </div>\n\n<script>\n(function() {\n    if (window.MASTER_UI_INITIALIZED) return;\n    window.MASTER_UI_INITIALIZED = true;\n    console.log(\"--- [天下为棋 Master UI v21] 多气泡分离模式 ---\"); \n\n    // --- [ 1. GLOBAL HELPERS ] ---\n    window.last_stat_data = {}; \n    let selectedParticipantKey = 'player'; \n    let currentCombatTab = 'skills'; \n\n    const isObject = (item) => (item && typeof item === 'object' && !Array.isArray(item));\n    const setToggle = (id, visible) => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !visible); };\n    const deepMerge = (target, source) => {\n        let output = Object.assign({}, target);\n        if (isObject(target) && isObject(source)) {\n            Object.keys(source).forEach(key => {\n                if (key === '$meta') return;\n                if (isObject(source[key])) {\n                    if (!(key in target) || !isObject(target[key])) { Object.assign(output, { [key]: source[key] }); } \n                    else { output[key] = deepMerge(target[key], source[key]); }\n                } else { Object.assign(output, { [key]: source[key] }); }\n            });\n        }\n        return output;\n    };\n    const SafeGetValue = (obj, path, defaultValue) => {\n        try {\n            if (!obj || typeof obj !== 'object') return defaultValue;\n            const keys = path.split('.');\n            let current = obj;\n            for (let i = 0; i < keys.length; i++) {\n                const key = keys[i];\n                const match = key.match(/^(.+?)\\[(\\d+)\\]$/);\n                if (match) {\n                    const arrayKey = match[1];\n                    const index = parseInt(match[2], 10);\n                    if (current && typeof current === 'object' && arrayKey in current && Array.isArray(current[arrayKey]) && index >= 0 && index < current[arrayKey].length) {\n                        current = current[arrayKey][index];\n                    } else { return defaultValue; }\n                } else if (current && typeof current === 'object' && key in current) {\n                    current = current[key];\n                } else { return defaultValue; }\n            }\n            return (current === undefined || current === null) ? defaultValue : current;\n        } catch (error) {\n            console.warn(`SafeGetValue 警告: path \"${path}\" 取值失败。`, error);\n            return defaultValue;\n        }\n    };\n    const getDataBlock = (root, path) => {\n        let val = SafeGetValue(root, path, undefined);\n        if (val === undefined) val = SafeGetValue(root, `${path}[0]`, undefined);\n        if (Array.isArray(val)) { if (val.length > 0 && typeof val[0] === 'object' && val[0] !== null) return val[0]; return {}; }\n        if (typeof val === 'object' && val !== null) return val;\n        return {};\n    };\n    const getKeys = (obj) => Object.keys(obj || {}).filter(k => k !== '$meta' && k !== '__description');\n    const normalizeText = (str) => (str ?? '').toString().replace(/\\\\\\\\n/g, '\\n').replace(/\\\\n/g, '\\n');\n    const normalizeHtml = (str) => normalizeText(str).replace(/\\n/g, '<br>');\n\n    // 默认空状态\n    const defaultMasterEmptyState = {\n        \"UI状态\": { \"当前界面\": [\"日常\", \"\"] },\n        \"战斗状态\": { \"战斗者\": [ { \"$meta\": { \"extensible\": true } } ], \"当前目标\": [\"player\", \"\"], \"预输入\": [\"\", \"\"], \"战斗日志\": [\"\", \"\"] },\n        \"世界\": { \"时间\": [\"（暂无）\", \"\"], \"地点\": [\"（暂无）\", \"\"] },\n        \"主角\": { \"势力\": [\"群雄\", \"\"], \"声望\": [\"无名之辈\", \"\"], \"命\": [1000, \"\"], \"法\": [1000, \"\"], \"武力\": [0, \"\"], \"谋略\": [0, \"\"], \"魅力\": [0, \"\"], \"官职\": [\"无\", \"\"], \"血脉\": [\"凡人\", \"\"], \"仙术\": [ { \"$meta\": { \"extensible\": true } } ] },\n        \"行囊\": { \n            \"装备\": { \"武器\": [\"无\", \"\"], \"防具\": [\"无\", \"\"], \"饰品\": [\"无\", \"\"] }, \n            \"背包\": [ { \"$meta\": { \"extensible\": true } } ] \n        },\n        \"关系表\": [ { \"$meta\": { \"extensible\": true } } ],\n        \"结缘录\": [ { \"$meta\": { \"extensible\": true } } ],\n        \"天下闻\": { \"奇闻\": [\"（暂无奇闻）\", \"\"], \"当前剧情\": [\"（等待开局...）\", \"\"], \"咏叹\": [\"（暂无诗篇）\", \"\"] }\n    };\n\n    // MVU 交互助手（保持）\n    window.SillyTavern_MVU_Set = (path, old_val, new_val, comment = \"UI: Set\") => {\n        if (typeof Mvu === 'undefined') return console.warn(\"[MasterUI] Mvu not found!\");\n        Mvu.setVariable(path, old_val, new_val, comment);\n    };\n    window.SillyTavern_TriggerSlash = (command) => {\n        if (typeof triggerSlash === 'function') {\n            console.log(`[MasterUI] Triggering Slash: ${command}`);\n            triggerSlash(command);\n        } else {\n            console.warn('triggerSlash function not found. Command:', command);\n            alert(`Error: triggerSlash function not found. Cannot send command:\\n${command}`);\n        }\n    };\n\n    // --- [ 2. 片段渲染（*修改*） ] ---\n    // *修改*：populate... 函数现在只返回 .section-content 内部的内容\n    \n    const emptyIcon = `<p class=\"empty-state-text\">(空)</p>`;\n    const emptyVal = \"---\";\n    const daily_updateProgressBar = (barId, current, max) => {\n        const bar = document.getElementById(barId);\n        if (bar) {\n            const percentage = max > 0 ? (current / max) * 100 : 0;\n            bar.style.width = `${Math.max(0, Math.min(100, percentage))}%`;\n        }\n    };\n    function populateWorldInfo(worldData) {\n        return `\n        <div class=\"world-info-box\">\n            <p><i class=\"fa-solid fa-clock\"></i> <span class=\"property-name\">时间:</span> <span class=\"value-main\">${SafeGetValue(worldData, '时间[0]', emptyVal)}</span></p>\n            <p><i class=\"fa-solid fa-map-location-dot\"></i> <span class=\"property-name\">地点:</span> <span class=\"value-main\">${SafeGetValue(worldData, '地点[0]', emptyVal)}</span></p>\n        </div>`;\n    }\n    function populateProtagonist(protagonistData) {\n        const statIcons = { '声望': 'fa-star-half-alt', '官职': 'fa-scroll', '血脉': 'fa-dna', '武力': 'fa-gavel', '谋略': 'fa-brain', '魅力': 'fa-heart-circle-bolt' };\n        const statsHtml = `\n            <div class=\"char-property-grid\">\n                <i class=\"fa-solid ${statIcons['声望']} char-icon\"></i><span class=\"char-prop-name\">声望</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '声望[0]', emptyVal)}</span>\n                <i class=\"fa-solid ${statIcons['官职']} char-icon\"></i><span class=\"char-prop-name\">官职</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '官职[0]', emptyVal)}</span>\n                <i class=\"fa-solid ${statIcons['血脉']} char-icon\"></i><span class=\"char-prop-name\">血脉</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '血脉[0]', emptyVal)}</span>\n                <i class=\"fa-solid ${statIcons['武力']} char-icon\"></i><span class=\"char-prop-name\">武力</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '武力[0]', 0)}</span>\n                <i class=\"fa-solid ${statIcons['谋略']} char-icon\"></i><span class=\"char-prop-name\">谋略</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '谋略[0]', 0)}</span>\n                <i class=\"fa-solid ${statIcons['魅力']} char-icon\"></i><span class=\"char-prop-name\">魅力</span><span class=\"char-prop-value\">${SafeGetValue(protagonistData, '魅力[0]', 0)}</span>\n            </div>`;\n        const skills = getDataBlock(protagonistData, '仙术');\n        const skillKeys = getKeys(skills);\n        let skillsHtml = '';\n        if (skillKeys.length > 0) {\n            skillsHtml = skillKeys.map(key => {\n                const skill = skills[key];\n                if (!isObject(skill)) return '';\n                return `<details class=\"sub-section\">\n                            <summary>${SafeGetValue(skill, '名称[0]', key)}<span class=\"arrow-toggle\">&gt;</span></summary>\n                            <div class=\"sub-section-content news-content\">\n                                ${normalizeHtml(SafeGetValue(skill, '描述[0]', '暂无描述。'))}\n                            </div>\n                        </details>`;\n            }).join('');\n        } else {\n            skillsHtml = emptyIcon;\n        }\n        // *修改*：移除 <details class=\"section\"> 和 <summary> 包装\n        return `\n        <div class=\"section-content\">\n            ${statsHtml}<hr><h4>仙术/技能</h4>${skillsHtml}\n        </div>`;\n    }\n    function populateHangnang(hangnangData) {\n        const equipmentData = SafeGetValue(hangnangData, '装备', {});\n        const equipmentHtml = `\n            <div class=\"char-property-grid\">\n                <i class=\"fa-solid fa-khanda char-icon\"></i><span class=\"char-prop-name\">武器</span><span class=\"char-prop-value\">${SafeGetValue(equipmentData, '武器[0]', emptyVal)}</span>\n                <i class=\"fa-solid fa-shirt char-icon\"></i><span class=\"char-prop-name\">防具</span><span class=\"char-prop-value\">${SafeGetValue(equipmentData, '防具[0]', emptyVal)}</span>\n                <i class=\"fa-solid fa-gem char-icon\"></i><span class=\"char-prop-name\">饰品</span><span class=\"char-prop-value\">${SafeGetValue(equipmentData, '饰品[0]', emptyVal)}</span>\n            </div>`;\n        const backpack = getDataBlock(hangnangData, '背包');\n        const backpackKeys = getKeys(backpack);\n        let backpackHtml = '';\n        if (backpackKeys.length > 0) {\n            backpackHtml = backpackKeys.map(key => {\n                const item = backpack[key];\n                if (!isObject(item)) return '';\n                return `<div class=\"item-row\">\n                            <span class=\"value-main\">${SafeGetValue(item, '名称[0]', key)}</span>\n                            <span class=\"property-name\">x ${SafeGetValue(item, '数量[0]', 0)}</span>\n                        </div>`;\n            }).join('');\n        } else { backpackHtml = emptyIcon; }\n        // *修改*：移除 <details class=\"section\"> 和 <summary> 包装\n        return `\n        <div class=\"section-content\">\n            <details class=\"sub-section\" open>\n                <summary>装备<span class=\"arrow-toggle\">&gt;</span></summary>\n                <div class=\"sub-section-content\">${equipmentHtml}</div>\n            </details>\n            <details class=\"sub-section\">\n                <summary>背包<span class=\"arrow-toggle\">&gt;</span></summary>\n                <div class=\"sub-section-content\">${backpackHtml}</div>\n            </details>\n        </div>`;\n    }\n    function populateRelationships(data) {\n        const relationships = getDataBlock(data, '关系表');\n        const allNpcs = getDataBlock(data, '结缘录');\n        const relKeys = getKeys(relationships);\n        let relationshipsHtml = '';\n        if (relKeys.length > 0) {\n            relationshipsHtml = relKeys.map(key => {\n                const relationship = relationships[key];\n                const npcName = SafeGetValue(allNpcs, `${key}.姓名[0]`, key);\n                const relText = (typeof relationship === 'string') ? relationship : JSON.stringify(relationship);\n                return `<div class=\"item-row\">\n                            <span class=\"value-main\">${npcName}</span>\n                            <span class=\"property-name\">${relText}</span>\n                        </div>`;\n            }).join('');\n        } else { relationshipsHtml = emptyIcon; }\n        // *修改*：移除 <details class=\"section\"> 和 <summary> 包装\n        return `\n        <div class=\"section-content\">${relationshipsHtml}</div>`;\n    }\n    function populateFates(data) {\n        const fates = getDataBlock(data, '结缘录');\n        const fateKeys = getKeys(fates);\n        let fatesHtml = '';\n        if (fateKeys.length > 0) {\n            fatesHtml = fateKeys.map(key => {\n                const npc = fates[key];\n                if (!isObject(npc)) return '';\n                const npcName = SafeGetValue(npc, '姓名[0]', key);\n                const favor = SafeGetValue(npc, '好感度[0]', 0);\n                const barId = `favor-bar-${key}`;\n                const npcStatsHtml = `\n                    <div class=\"char-property-grid\">\n                        <i class=\"fa-solid fa-address-card char-icon\"></i><span class=\"char-prop-name\">官职</span><span class=\"char-prop-value\">${SafeGetValue(npc, '官职[0]', emptyVal)}</span>\n                        <i class=\"fa-solid fa-cake-candles char-icon\"></i><span class=\"char-prop-name\">年龄</span><span class=\"char-prop-value\">${SafeGetValue(npc, '年龄[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-gavel char-icon\"></i><span class=\"char-prop-name\">武力</span><span class=\"char-prop-value\">${SafeGetValue(npc, '武力[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-brain char-icon\"></i><span class=\"char-prop-name\">谋略</span><span class=\"char-prop-value\">${SafeGetValue(npc, '谋略[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-heart char-icon\"></i><span class=\"char-prop-name\">魅力</span><span class=\"char-prop-value\">${SafeGetValue(npc, '魅力[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-hand-holding-heart char-icon\"></i><span class=\"char-prop-name\">关系</span><span class=\"char-prop-value\">${SafeGetValue(npc, '当前关系[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-khanda char-icon\"></i><span class=\"char-prop-name\">武器</span><span class=\"char-prop-value\">${SafeGetValue(npc, '武器[0]', 'N/A')}</span>\n                        <i class=\"fa-solid fa-horse char-icon\"></i><span class=\"char-prop-name\">坐骑</span><span class=\"char-prop-value\">${SafeGetValue(npc, '坐骑[0]', 'N/A')}</span>\n                    </div>\n                    <hr>\n                    <p><span class=\"property-name\">外貌:</span> <span class=\"value-main\">${SafeGetValue(npc, '外貌[0]', 'N/A')}</span></p>\n                    <p><span class=\"property-name\">衣着:</span> <span class=\"value-main\">${SafeGetValue(npc, '衣着[0]', 'N/A')}</span></p>\n                    <hr>\n                    <p style=\"text-align: center;\"><span class=\"property-name\">好感度: ${favor} / 1000</span></p>\n                    <div class=\"char-favor-bar-container\"><div id=\"${barId}\" class=\"char-favor-bar\"></div></div>\n                    `;\n                return `<details class=\"sub-section\">\n                            <summary>${npcName}<span class=\"arrow-toggle\">&gt;</span></summary>\n                            <div class=\"sub-section-content\">${npcStatsHtml}</div>\n                        </details>`;\n            }).join('');\n        } else { fatesHtml = emptyIcon; }\n        setTimeout(() => {\n            if (fateKeys.length > 0) {\n                fateKeys.forEach(key => {\n                    const npc = fates[key]; \n                    if (!isObject(npc)) return;\n                    const favor = SafeGetValue(npc, '好感度[0]', 0);\n                    daily_updateProgressBar(`favor-bar-${key}`, favor, 1000);\n                });\n            }\n        }, 0);\n        // *修改*：移除 <details class=\"section\"> 和 <summary> 包装\n        return `\n        <div class=\"section-content\">${fatesHtml}</div>`;\n    }\n    function populateNews(newsData) {\n        const strangeNews = normalizeHtml(SafeGetValue(newsData, '奇闻[0]', '暂无奇闻'));\n        const currentPlot = normalizeHtml(SafeGetValue(newsData, '当前剧情[0]', '暂无剧情'));\n        const newsHtml = `\n            <details class=\"sub-section\">\n                <summary><i class=\"fa-solid fa-scroll\" style=\"margin-right: 8px; opacity: 0.7;\"></i>奇闻<span class=\"arrow-toggle\">&gt;</span></summary>\n                <div class=\"sub-section-content news-content\">\n                    ${strangeNews || emptyIcon}\n                </div>\n            </details>\n            <details class=\"sub-section\">\n                <summary><i class=\"fa-solid fa-theater-masks\" style=\"margin-right: 8px; opacity: 0.7;\"></i>当前剧情<span class=\"arrow-toggle\">&gt;</span></summary>\n                <div class=\"sub-section-content news-content\">\n                    ${currentPlot || emptyIcon}\n                </div>\n            </details>`;\n        // *修改*：移除 <details class=\"section\"> 和 <summary> 包装\n        return `\n        <div class=\"section-content\">${newsHtml}</div>`;\n    }\n    function populateYongtan(newsData) {\n        const yongtan_raw = SafeGetValue(newsData, '咏叹[0]', '（暂无诗篇）');\n        const text = normalizeText(yongtan_raw);\n        const lines = text.split('\\n').filter(line => line.trim() !== '');\n        let poemHtml = '<div class=\"poem-grid\">';\n        for (let i = 0; i < 8; i += 2) {\n            poemHtml += `<p>${lines[i] || '...'}</p>`;\n            poemHtml += `<p>${lines[i+1] || '...'}</p>`;\n        }\n        poemHtml += '</div>';\n        return `\n        <div class=\"master-ui-title yongtan-footer\">\n            <h1>宿命咏叹</h1>\n            ${poemHtml}\n        </div>`;\n    }\n\n    // --- [ 3. 日常 UI 渲染（*重构为多气泡*） ] ---\n    function renderDailyUI(data) {\n        const wrapper = document.getElementById('chessboard-container-wrapper');\n        if (!wrapper) { console.error(\"[MasterUI] Daily UI wrapper not found!\"); return; }\n\n        const faction = SafeGetValue(data,'主角.势力[0]','群雄');\n        let themeClass = 'theme-imperial'; \n        if ((faction || '').includes('汉') || (faction || '').toLowerCase().includes('han')) themeClass = 'theme-draconic';\n        else if ((faction || '').includes('魏') || (faction || '').toLowerCase().includes('wei')) themeClass = 'theme-abyss';\n        else if ((faction || '').includes('吴') || (faction || '').toLowerCase().includes('wu')) themeClass = 'theme-elven';\n        wrapper.className = `status-container ${themeClass}`;\n\n        // *修改*：populate... 函数现在只返回内容 HTML\n        const worldHtml = populateWorldInfo(SafeGetValue(data, '世界', {}));\n        const protagonistHtml = populateProtagonist(SafeGetValue(data, '主角', {}));\n        const hangnangHtml = populateHangnang(SafeGetValue(data, '行囊', {}));\n        const relationshipsHtml = populateRelationships(data); \n        const fatesHtml = populateFates(data);\n        const newsData = SafeGetValue(data, '天下闻', {}); \n        const newsHtml = populateNews(newsData);\n        const yongtanHtml = populateYongtan(newsData); \n\n        // *修改*：重构为多气泡 HTML 结构\n        wrapper.innerHTML = `\n            <div class=\"master-ui-title\"><h1>无双志</h1></div>\n            ${worldHtml} \n\n            <section class=\"bubble-shell\" id=\"bubble-shell-protagonist\">\n                <button class=\"bubble-toggle\" aria-expanded=\"true\" data-controls=\"bubble-content-protagonist\">\n                    <span class=\"pulse-dot\" aria-hidden=\"true\"></span>\n                    <span><i class=\"fa-solid fa-user summary-icon\"></i> 主角</span>\n                </button>\n                <div class=\"big-bubble\" id=\"bubble-content-protagonist\">\n                    <div class=\"bubble-inner\">\n                        ${protagonistHtml}\n                    </div>\n                </div>\n            </section>\n\n            <section class=\"bubble-shell\" id=\"bubble-shell-hangnang\">\n                <button class=\"bubble-toggle\" aria-expanded=\"false\" data-controls=\"bubble-content-hangnang\">\n                    <span class=\"pulse-dot\" aria-hidden=\"true\"></span>\n                    <span><i class=\"fa-solid fa-briefcase summary-icon\"></i> 行囊</span>\n                </button>\n                <div class=\"big-bubble\" id=\"bubble-content-hangnang\">\n                    <div class=\"bubble-inner\">\n                        ${hangnangHtml}\n                    </div>\n                </div>\n            </section>\n\n            <section class=\"bubble-shell\" id=\"bubble-shell-relationships\">\n                <button class=\"bubble-toggle\" aria-expanded=\"false\" data-controls=\"bubble-content-relationships\">\n                    <span class=\"pulse-dot\" aria-hidden=\"true\"></span>\n                    <span><i class=\"fa-solid fa-users summary-icon\"></i> 关系表</span>\n                </button>\n                <div class=\"big-bubble\" id=\"bubble-content-relationships\">\n                    <div class=\"bubble-inner\">\n                        ${relationshipsHtml}\n                    </div>\n                </div>\n            </section>\n\n            <section class=\"bubble-shell\" id=\"bubble-shell-fates\">\n                <button class=\"bubble-toggle\" aria-expanded=\"false\" data-controls=\"bubble-content-fates\">\n                    <span class=\"pulse-dot\" aria-hidden=\"true\"></span>\n                    <span><i class=\"fa-solid fa-book-open summary-icon\"></i> 结缘录</span>\n                </button>\n                <div class=\"big-bubble\" id=\"bubble-content-fates\">\n                    <div class=\"bubble-inner\">\n                        ${fatesHtml}\n                    </div>\n                </div>\n            </section>\n\n            <section class=\"bubble-shell\" id=\"bubble-shell-news\">\n                <button class=\"bubble-toggle\" aria-expanded=\"false\" data-controls=\"bubble-content-news\">\n                    <span class=\"pulse-dot\" aria-hidden=\"true\"></span>\n                    <span><i class=\"fa-solid fa-newspaper summary-icon\"></i> 天下闻</span>\n                </button>\n                <div class=\"big-bubble\" id=\"bubble-content-news\">\n                    <div class=\"bubble-inner\">\n                        ${newsHtml}\n                    </div>\n                </div>\n            </section>\n\n            ${yongtanHtml} \n        `;\n\n        // *修改*：调用新的初始化函数\n        initializeDailyBubbles();\n    }\n\n    // *新增*：初始化所有气泡（设置初始高度 + 挂载 ResizeObserver）\n    function initializeDailyBubbles() {\n        const wrapper = document.getElementById('chessboard-container-wrapper');\n        if (!wrapper) return;\n\n        const shells = wrapper.querySelectorAll('.bubble-shell');\n        shells.forEach(shell => {\n            const bubble = shell.querySelector('.big-bubble');\n            const inner = shell.querySelector('.bubble-inner');\n            const toggle = shell.querySelector('.bubble-toggle');\n            if (!toggle || !bubble || !inner) return;\n\n            // 1. 根据 aria-expanded 属性设置初始开合状态\n            const isExpanded = toggle.getAttribute('aria-expanded') === 'true';\n            if (isExpanded) {\n                shell.classList.add('open');\n                bubble.style.maxHeight = inner.scrollHeight + 'px';\n            } else {\n                shell.classList.remove('open');\n                bubble.style.maxHeight = '0px';\n            }\n\n            // 2. 挂载 ResizeObserver，确保展开/收起 <details> 时父气泡高度自适应\n            // 检查是否已有 RO，防止重复挂载\n            if (inner._resizeObserver) inner._resizeObserver.disconnect();\n            \n            const ro = new ResizeObserver(() => {\n                if (shell.classList.contains('open')) {\n                    // 动态调整 maxHeight\n                    bubble.style.maxHeight = inner.scrollHeight + 'px';\n                }\n            });\n            ro.observe(inner);\n            inner._resizeObserver = ro; // 存储 RO 实例以便后续清理\n        });\n    }\n\n    // --- [ 4. 战斗 UI 渲染器（保持你的实现） ] ---\n    window.battle_ui_events = {\n        selectTab: (tabName) => { currentCombatTab = tabName; renderBattleUI(window.last_stat_data); },\n        _addToPreInput: (text) => {\n            try {\n                const preInputEl = document.getElementById('pre-input-bar');\n                if (!preInputEl) return;\n                const oldText_DOM = preInputEl.value;\n                const oldText_MVU = SafeGetValue(window.last_stat_data, '战斗状态.预输入[0]', '');\n                const newText_DOM = oldText_DOM ? oldText_DOM + '\\n' + text : text;\n                const newText_MVU = oldText_MVU ? oldText_MVU + '\\\\n' + text : text; \n                preInputEl.value = newText_DOM;\n                if (window.last_stat_data && window.last_stat_data['战斗状态'] && window.last_stat_data['战斗状态']['预输入']) {\n                    window.last_stat_data['战斗状态']['预输入'][0] = newText_MVU;\n                }\n                window.SillyTavern_MVU_Set('战斗状态.预输入[0]', oldText_MVU, newText_MVU, 'UI: 添加行动');\n            } catch(e) { console.error(\"[MasterUI] _addToPreInput failed:\", e); }\n        },\n        _getCurrentTargetName: () => {\n            return SafeGetValue(window.last_stat_data, `战斗状态.战斗者[0].${selectedParticipantKey}.名称[0]`, '??');\n        },\n        useSkill: (skillName, skillKey) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [使用技能] ${skillName}`); },\n        useItem: (itemName, itemKey) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [使用物品] ${itemName}`); },\n        coreAction: (action) => { window.battle_ui_events._addToPreInput(`${window.battle_ui_events._getCurrentTargetName()} [${action}]`); },\n        startTurn: () => {\n            try {\n                const preInputEl = document.getElementById('pre-input-bar');\n                if (!preInputEl) return;\n                const textToSend = preInputEl.value; \n                const oldText_MVU = SafeGetValue(window.last_stat_data, '战斗状态.预输入[0]', ''); \n                if (textToSend && textToSend.trim() !== '') {\n                    const formattedCommand = `/send ${textToSend.replace(/\\n/g, ' ')} |/trigger`;\n                    window.SillyTavern_TriggerSlash(formattedCommand); \n                    preInputEl.value = '';\n                    if (window.last_stat_data && window.last_stat_data['战斗状态'] && window.last_stat_data['战斗状态']['预输入']) {\n                        window.last_stat_data['战斗状态']['预输入'][0] = '';\n                    }\n                    window.SillyTavern_MVU_Set('战斗状态.预输入[0]', oldText_MVU, '', 'UI: 清空预输入并已发送');\n                } else { console.warn(\"[MasterUI-Battle] 预输入为空，不发送。\"); }\n            } catch(e) { console.error(\"[MasterUI] startTurn failed:\", e); }\n        },\n        endBattle: () => { window.SillyTavern_TriggerSlash('/send [系统指令：战斗结束，请求结算] |/trigger'); }\n    };\n\n    function getParticipantData_v15(key, fullData) {\n        let skills = getDataBlock(fullData, `战斗状态.战斗者[0].${key}.仙术`);\n        let items  = getDataBlock(fullData, `战斗状态.战斗者[0].${key}.背包`);\n        const hasPayload = (o) => isObject(o) && getKeys(o).length > 0;\n        if (!hasPayload(skills)) {\n            if (key === 'player') skills = getDataBlock(fullData, '主角.仙术');\n            else skills = getDataBlock(fullData, `结缘录.${key.replace(/^npc_/, '')}.仙术`);\n        }\n        if (!hasPayload(items)) {\n            if (key === 'player') items = getDataBlock(fullData, '行囊.背包');\n            else items = getDataBlock(fullData, `结缘录.${key.replace(/^npc_/, '')}.背包`);\n        }\n        return { skills, items };\n    }\n\n    function renderBattleUI(data) {\n        const wrapper = document.getElementById('battle-ui-wrapper');\n        if (!wrapper) { console.error(\"[MasterUI] Battle UI wrapper not found!\"); return; }\n        const playerArea = document.getElementById('player-combatants-area');\n        const enemyArea = document.getElementById('enemy-combatants-area');\n        const playerPlaceholder = document.getElementById('player-combatants-placeholder');\n        const enemyPlaceholder = document.getElementById('enemy-combatants-placeholder');\n        \n        playerArea.innerHTML = '<div class=\"team-title\">我方阵营</div>';\n        enemyArea.innerHTML = '<div class=\"team-title\">敌方阵营</div>';\n\n        const combatantsObj = SafeGetValue(data, '战斗状态.战斗者[0]', {});\n        const combatantKeys = Object.keys(combatantsObj).filter(k => k !== '$meta' && k !== '__description');\n        \n        if (!combatantsObj[selectedParticipantKey]) {\n            const firstPlayerAlly = combatantKeys.find(k => {\n                const type = SafeGetValue(combatantsObj[k], '类型[0]', '未知');\n                return type === '主角' || type === '友军';\n            });\n            selectedParticipantKey = firstPlayerAlly || combatantKeys[0] || null;\n        }\n\n        let playerUnitsFound = 0;\n        let enemyUnitsFound = 0;\n\n        combatantKeys.forEach(key => {\n            const unit = combatantsObj[key];\n            if (!isObject(unit)) return;\n            const name = SafeGetValue(unit, '名称[0]', key);\n            const type = SafeGetValue(unit, '类型[0]', '未知');\n            const hp_val = SafeGetValue(unit, '命[0]', 0);\n            const hp_max = SafeGetValue(unit, '命[1]', 100);\n            const mp_val = SafeGetValue(unit, '法[0]', 0);\n            const mp_max = SafeGetValue(unit, '法[1]', 100);\n            const hp_perc = hp_max > 0 ? (hp_val / hp_max) * 100 : 0;\n            const mp_perc = mp_max > 0 ? (mp_val / mp_max) * 100 : 0;\n            const isSelected = (key === selectedParticipantKey); \n            const isClickable = (type === '主角' || type === '友军');\n\n            let barHtml = `<div class=\"combatant-bar ${isSelected ? 'selected' : ''} ${isClickable ? '' : 'non-clickable'}\" \n                                ${isClickable ? `data-key=\"${key}\"` : ''}> \n                                <div class=\"combatant-header\">\n                                    <span class=\"combatant-name\">${name}</span>\n                                    <span class=\"combatant-type\">${type}</span>\n                                </div>\n                                <div class=\"stat-bars\">\n                                    <div class=\"stat-bar\"><div class=\"stat-bar-value hp\" style=\"width: ${hp_perc}%;\"></div><div class=\"stat-bar-text\"><span class=\"label\">命:</span> ${hp_val} / ${hp_max}</div></div>\n                                    <div class=\"stat-bar\"><div class=\"stat-bar-value mp\" style=\"width: ${mp_perc}%;\"></div><div class=\"stat-bar-text\"><span class=\"label\">法:</span> ${mp_val} / ${mp_max}</div></div>\n                                </div>\n                             </div>`;\n\n            if (type === '主角' || type === '友军') { playerArea.innerHTML += barHtml; playerUnitsFound++; } \n            else if (type === '敌军') { enemyArea.innerHTML += barHtml; enemyUnitsFound++; }\n        });\n\n        if (playerUnitsFound === 0) playerArea.appendChild(playerPlaceholder.cloneNode(true)); \n        if (enemyUnitsFound === 0) enemyArea.appendChild(enemyPlaceholder.cloneNode(true)); \n\n        const tabContentArea = document.getElementById('tab-content-area');\n        tabContentArea.innerHTML = '';\n        \n        document.getElementById('tab-btn-skills').classList.toggle('active-tab', currentCombatTab === 'skills');\n        document.getElementById('tab-btn-bags').classList.toggle('active-tab', currentCombatTab === 'bags');\n\n        const { skills, items } = getParticipantData_v15(selectedParticipantKey, data);\n        \n        if (currentCombatTab === 'skills') {\n            const skillKeys = getKeys(skills);\n            if (skillKeys.length > 0) {\n                skillKeys.forEach(key => {\n                    const skill = skills[key];\n                    if (!isObject(skill)) return;\n                    const name = SafeGetValue(skill, '名称[0]', key);\n                    const cost = SafeGetValue(skill, '消耗[0]', '无消耗');\n                    const desc = SafeGetValue(skill, '描述[0]', '暂无描述。');\n                    tabContentArea.innerHTML += `<button class=\"action-item-button\" onclick=\"window.battle_ui_events.useSkill('${name}', '${key}')\"><div><div class=\"action-item-name\">${name}</div><div class=\"action-item-desc\">${normalizeText(desc)}</div></div><div class=\"action-item-cost\">${cost}</div></button>`;\n                });\n            } else { tabContentArea.innerHTML = '<p class=\"empty-state-text\">(暂无技能)</p>'; }\n        } else { \n            const bagKeys = getKeys(items);\n            if (bagKeys.length > 0) {\n                bagKeys.forEach(key => {\n                    const item = items[key];\n                    if (!isObject(item)) return;\n                    const name = SafeGetValue(item, '名称[0]', key);\n                    const count = SafeGetValue(item, '数量[0]', 0);\n                    const desc = SafeGetValue(item, '描述[0]', '暂无描述。');\n                    if (count <= 0) return; \n                    tabContentArea.innerHTML += `<button class=\"action-item-button\" onclick=\"window.battle_ui_events.useItem('${name}', '${key}')\"><div><div class=\"action-item-name\">${name}</div><div class=\"action-item-desc\">${normalizeText(desc)}</div></div><div class=\"action-item-count\">x ${count}</div></button>`;\n                });\n                if (tabContentArea.innerHTML === '') { tabContentArea.innerHTML = '<p class=\"empty-state-text\">(行囊为空)</p>'; }\n            } else { tabContentArea.innerHTML = '<p class=\"empty-state-text\">(行囊为空)</p>'; }\n        }\n\n        const preInputEl = document.getElementById('pre-input-bar');\n        const logEl = document.getElementById('battle-log-content');\n        if (preInputEl.value.trim() === '') { preInputEl.value = normalizeText(SafeGetValue(data, '战斗状态.预输入[0]', '')); }\n        logEl.innerHTML = normalizeHtml(SafeGetValue(data, '战斗状态.战斗日志[0]', '(战斗日志将显示于此...)'));\n        logEl.scrollTop = logEl.scrollHeight;\n        \n        const endBattleOverlay = document.getElementById('end-battle-overlay');\n        const enemies = combatantKeys.filter(k => SafeGetValue(combatantsObj[k], '类型[0]', '未知') === '敌军');\n        const enemiesAlive = enemies.filter(k => SafeGetValue(combatantsObj[k], '命[0]', 0) > 0).length;\n        const uiMode = SafeGetValue(data, 'UI状态.当前界面[0]', '日常'); \n        if (uiMode === '战斗' && enemiesAlive === 0) { endBattleOverlay.classList.remove('hidden'); } \n        else { endBattleOverlay.classList.add('hidden'); }\n    }\n\n    // --- [ 5. 主渲染路由 ] ---\n    function Master_Render_UI(data) {\n        if (!data || typeof data !== 'object') {\n            console.warn(\"[MasterUI] Master_Render_UI 收到无效数据。\");\n            return;\n        }\n        window.last_stat_data = data; \n        const uiMode = SafeGetValue(data, 'UI状态.当前界面[0]', '日常');\n        setToggle('chessboard-container-wrapper', uiMode === '日常');\n        setToggle('battle-ui-wrapper', uiMode === '战斗');\n        if (uiMode === '日常') renderDailyUI(data); else renderBattleUI(data);\n    }\n\n    // --- [ 6. 初始化 (*修改*) ] ---\n    async function Master_Init() {\n        console.log(\"--- [天下为棋 Master UI v21] Master_Init 启动 (多气泡版) ---\");\n        try {\n            const hasChat = typeof getChatMessages === 'function' && typeof getCurrentMessageId === 'function';\n            const msgs = hasChat ? await getChatMessages(getCurrentMessageId()) : []; \n            const data = msgs?.[0]?.data?.stat_data; \n            let mergedData;\n            if (data && typeof data === 'object') {\n                console.log(\"[MasterUI] 发现 stat_data。与默认值合并。\");\n                mergedData = deepMerge(defaultMasterEmptyState, data); \n            } else {\n                console.warn('[MasterUI] 未发现 stat_data。使用默认空状态。');\n                mergedData = defaultMasterEmptyState;\n            }\n            Master_Render_UI(mergedData);\n            console.log(\"--- [MasterUI] Master_Init 完成 ---\");\n\n            // *修改*：全局点击监听器，现在同时处理战斗和日常UI\n            document.addEventListener('click', function(event) {\n                const target = event.target;\n                \n                // --- 逻辑 1：战斗 UI 点击 ---\n                const combatWrapper = document.getElementById('battle-ui-wrapper');\n                if (combatWrapper && !combatWrapper.classList.contains('hidden')) {\n                    const combatantBar = target.closest && target.closest('.combatant-bar[data-key]');\n                    if (combatantBar) {\n                        const newKey = combatantBar.dataset.key;\n                        if (newKey !== selectedParticipantKey) {\n                            console.log(\"[MasterUI] 切换战斗目标 (本地):\", newKey);\n                            selectedParticipantKey = newKey;\n                            renderBattleUI(window.last_stat_data);\n                        }\n                        return; // 已处理\n                    }\n                }\n\n                // --- 逻辑 2：日常 UI 气泡点击 (新) ---\n                const dailyWrapper = document.getElementById('chessboard-container-wrapper');\n                if (dailyWrapper && !dailyWrapper.classList.contains('hidden')) {\n                    const toggle = target.closest('.bubble-toggle');\n                    if (toggle) {\n                        const shell = toggle.closest('.bubble-shell');\n                        const contentId = toggle.getAttribute('data-controls');\n                        if (!contentId) return; // 不是我们控制的气泡\n                        \n                        const bubble = document.getElementById(contentId);\n                        if (!shell || !bubble) return;\n\n                        const isOpen = shell.classList.contains('open');\n\n                        // 设置动画原点\n                        const rect = bubble.getBoundingClientRect();\n                        const x = (event.clientX ?? (rect.left + rect.width / 2)) - rect.left;\n                        const y = (event.clientY ?? (rect.top + 16)) - rect.top;\n                        bubble.style.setProperty('--origin-x', x + 'px');\n                        bubble.style.setProperty('--origin-y', y + 'px');\n\n                        // 开合切换\n                        if (isOpen) {\n                            shell.classList.remove('open');\n                            toggle.setAttribute('aria-expanded', 'false');\n                            bubble.style.maxHeight = '0px';\n                        } else {\n                            const inner = bubble.querySelector('.bubble-inner');\n                            if (inner) {\n                                shell.classList.add('open');\n                                toggle.setAttribute('aria-expanded', 'true');\n                                bubble.style.maxHeight = inner.scrollHeight + 'px';\n                            }\n                        }\n                        return; // 已处理\n                    }\n                }\n            });\n\n            // 监听 MVU 变量更新\n            if (typeof waitGlobalInitialized === 'function') {\n                waitGlobalInitialized('Mvu').then(() => {\n                    if (typeof eventOn === 'function' && typeof Mvu !== 'undefined' && Mvu.events) {\n                        eventOn(Mvu.events.VARIABLE_UPDATE_ENDED, m => {\n                            if (m && m.stat_data && typeof m.stat_data === 'object') {\n                                Master_Render_UI(m.stat_data); \n                            } else {\n                                console.warn('[MasterUI] 收到 VARIABLE_UPDATE_ENDED 事件，但 stat_data 无效。');\n                            }\n                        });\n                    }\n                }).catch(()=>{});\n            }\n\n        } catch (e) {\n            console.error('CRITICAL Error during [MasterUI] Master_Init:', e);\n        }\n    }\n\n    if (typeof waitGlobalInitialized === 'function') {\n        console.log(\"[MasterUI] 等待 Mvu 初始化...\");\n        waitGlobalInitialized('Mvu').then(Master_Init).catch(() => document.addEventListener('DOMContentLoaded', Master_Init));\n    } else {\n        console.warn('[MasterUI] waitGlobalInitialized 未找到。在 DOMContentLoaded 上加载。');\n        document.addEventListener('DOMContentLoaded', Master_Init);\n    }\n})();\n</script>\n</body>\n</html>\n```",
    "trimStrings": [],
    "placement": [
        2
    ],
    "disabled": false,
    "markdownOnly": true,
    "promptOnly": false,
    "runOnEdit": true,
    "substituteRegex": 0,
    "minDepth": null,
    "maxDepth": 2
}